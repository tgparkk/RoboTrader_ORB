# RoboTrader ORB 전략 매매 분석 리포트

**일자**: 2026년 1월 28일 (수요일)
**모드**: 가상거래 (Virtual Trading)
**분석 시각**: 19:06 (장 마감 후) → **2026-01-28 재분석 반영**

---

## 요약 (Summary)

- **후보 80개 선정** → ORB 성공 63개 → **가상 매수 23종목 체결** (09:15~09:33). 가상 매수 기록은 DB `virtual_trading_records`에 **정상 저장**됨(23건).
- **15:00 일괄청산** 시 가상거래 분기 없이 **실제 KIS API 매도 주문** 호출 → `APBK0400`(주문 가능 수량 초과)로 **전량 실패**. 가상 매도 0건, 최종 손익 미정산.
- **원인**: `main.py`의 `_execute_end_of_day_liquidation()`이 `use_virtual_trading` 여부와 관계없이 `execute_sell_order`(실제 API)만 호출함. 장중 매도 판단(`_analyze_sell_decision`)에는 가상/실제 분기가 있으나, **EOD 청산에만 분기 누락**.

---

## 📊 전체 요약

| 항목 | 결과 |
|------|------|
| 거래 모드 | 가상거래 활성화 |
| 후보 종목 선정 | 80개 (DB `candidate_stocks` 2026-01-28: 114건) |
| ORB 레인지 계산 | 성공 63개 / 실패 17개 |
| 매수 체결 | 23종목 (가상) |
| 매도 체결 | 0종목 (15:00 청산 실패) |
| 가상 매수 DB 저장 | ✅ 23건 저장 확인 (`virtual_trading_records`) |
| 가상 매도 DB 저장 | ❌ 0건 (15:00 청산 미실행) |
| 최종 손익 | 미정산 |

---

## 1. 후보 종목 선정 (08:55)

### 선정 기준
- 갭 상승: 전일 종가 대비 0.3~3% 상승
- 거래대금: 100억원 이상 (전일 기준)
- ATR 유효성: 14일 ATR 계산 가능

### 선정 결과
**총 80개 종목 선정** (주요 10개 종목)

| 시간 | 종목코드 | 종목명 | 갭 상승률 | 거래대금 | ATR |
|------|---------|--------|----------|---------|-----|
| 08:55:04 | 000660 | SK하이닉스 | +1.25% | 2,440억 | 27,786원 |
| 08:55:05 | 207940 | 삼성바이오로직스 | +0.78% | 141억 | 50,714원 |
| 08:55:05 | 329180 | HD현대중공업 | +1.02% | 132억 | 26,143원 |
| 08:55:05 | 000270 | 기아 | +0.65% | 295억 | 10,039원 |
| 08:55:05 | 034020 | 두산에너빌리티 | +0.43% | 532억 | 4,193원 |
| 08:55:06 | 402340 | SK스퀘어 | +0.85% | 173억 | 20,750원 |
| 08:55:06 | 028260 | 삼성물산 | +0.67% | 106억 | 10,893원 |
| 08:55:06 | 042660 | 한화오션 | +0.57% | 264억 | 6,979원 |
| 08:55:07 | 035420 | NAVER | +1.60% | 760억 | 10,750원 |
| 08:55:07 | 012330 | 현대모비스 | +0.54% | 271억 | 30,429원 |

**선정 특징**:
- 대형주 위주 (SK하이닉스, 네이버, 삼성 계열 등)
- 갭 상승률 0.43~1.60% 범위
- 충분한 거래대금 확보 (100억원 이상)

---

## 2. ORB 레인지 계산 (09:10)

### 계산 결과
- **성공**: 63개 종목
- **실패**: 17개 종목
- **계산 방법**: 09:00~09:10 구간 1분봉 고가/저가

### 주요 종목 ORB 레인지

| 종목코드 | 종목명 | ORB 고가 | ORB 저가 | 레인지 | 레인지% |
|---------|--------|----------|----------|--------|---------|
| 000660 | SK하이닉스 | 816,000원 | 806,000원 | 10,000원 | 1.23% |
| 207940 | 삼성바이오로직스 | 1,814,000원 | 1,801,000원 | 13,000원 | 0.72% |
| 028260 | 삼성물산 | 302,000원 | 298,000원 | 4,000원 | 1.33% |
| 009150 | 삼성전기 | 281,500원 | 277,500원 | 4,000원 | 1.43% |
| 000880 | 한화 | 115,800원 | 114,200원 | 1,600원 | 1.39% |
| 002380 | KCC | 464,000원 | 458,500원 | 5,500원 | 1.19% |
| 011780 | 금호석유화학 | 151,600원 | 149,200원 | 2,400원 | 1.60% |
| 000100 | 유한양행 | 109,700원 | 108,400원 | 1,300원 | 1.19% |
| 005490 | POSCO홀딩스 | 366,500원 | 362,500원 | 4,000원 | 1.10% |
| 096770 | SK이노베이션 | 113,700원 | 112,400원 | 1,300원 | 1.15% |

**ORB 레인지 특징**:
- 대부분 0.7~2.5% 범위 (정상 범위)
- 레인지가 너무 좁거나 넓은 종목 자동 필터링됨

---

## 3. 매수 신호 및 체결 (09:15~)

### 매수 조건
- ORB 고가 돌파 (3분봉 기준)
- 거래량 1.5배 이상 (ORB 구간 평균 대비)
- 3분봉 완성 + 10초 시점에 판단

### 매수 체결 내역 (총 23종목)

| 시간 | 종목코드 | 종목명 | 매수가 | 수량 | 거래량 배수 | 비고 |
|------|---------|--------|--------|------|------------|------|
| 09:15:45 | 028260 | 삼성물산 | 302,000원 | 3주 | 3.7배 | 목표: 310,000 / 손절: 298,000 |
| 09:15:45 | 009150 | 삼성전기 | 283,000원 | 3주 | 5.9배 | 목표: 289,500 / 손절: 277,500 |
| 09:15:45 | 000880 | 한화 | 117,100원 | 7주 | 8.8배 | 목표: 119,000 / 손절: 114,200 |
| 09:15:45 | 002380 | KCC | 464,500원 | 1주 | 4.5배 | 목표: 475,500 / 손절: 458,500 |
| 09:15:45 | 011780 | 금호석유화학 | 151,800원 | 4주 | 5.6배 | 목표: 156,600 / 손절: 149,200 |
| 09:15:45 | 498400 | KODEX 200타겟위클리 | 16,475원 | 38주 | 1.8배 | 목표: 16,805 / 손절: 16,355 |
| 09:15:45 | 000100 | 유한양행 | 110,000원 | 5주 | 5.7배 | 목표: 111,300 / 손절: 108,400 |
| 09:15:45 | 450080 | 에코프로머티 | 66,300원 | 7주 | 5.6배 | 목표: 69,100 / 손절: 64,900 |
| 09:15:45 | 005490 | POSCO홀딩스 | 368,000원 | 1주 | 2.8배 | 목표: 376,000 / 손절: 362,500 |
| 09:15:45 | 096770 | SK이노베이션 | 114,000원 | 3주 | 2.7배 | 목표: 115,300 / 손절: 112,400 |
| ... | ... | ... | ... | ... | ... | (이하 13개 종목 생략) |

**매수 특징**:
- 대부분 09:15 시점에 집중 매수 발생
- 거래량 배수 1.7~8.8배 범위
- 총 투자 금액: 약 860만원 (초기 자금 1,000만원 중 86% 사용)

---

## 4. 매도 시도 및 실패 (15:00)

### 15:00 시장가 일괄청산 시도

**시도 내역**: 23종목 전체 매도 시도

**실패 원인**: API 오류 `APBK0400 - 주문 가능한 수량을 초과했습니다`

```
2026-01-28 15:00:00 | core.order_manager | INFO | 📉 매도 주문 시도: 028260 3주 @0원 (시장가: True)
2026-01-28 15:00:00 | api.kis_auth | ERROR | APBK0400 - 주문 가능한 수량을 초과했습니다.
```

**분석**:
- 가상거래 모드임에도 불구하고 실제 API 주문 시도
- 실제 계좌에는 보유 수량이 없어 "수량 초과" 에러 발생
- **모든 23개 포지션이 청산되지 않음**

---

## 5. 현상 (What happened)

- 08:55 후보 선정 80개 → 09:10 ORB 계산 63개 성공.
- 09:15~09:33 가상 매수 23종목 체결. `virtual_trading_records`에 BUY 23건 저장 확인 (DB 검증 완료).
- 장중 손절/익절 매도 신호 없음 → 15:00 일괄청산만 시도.
- 15:00 시장가 매도 시 **실제 API** 호출 → `APBK0400` 로 23종목 전부 실패. 가상 매도 0건.

---

## 6. 문제점 및 개선 필요 사항

### 🚨 심각한 문제

#### 1. ~~가상매매 DB 저장 실패~~ → **가상 매수 DB 저장은 정상**
- 2026-01-28 DB 조회: `virtual_trading_records`에 BUY 23건 존재 (028260, 009150, 000880, 002380, …).
- **가상 매도**는 15:00 청산이 실제 API로 시도되어 실행되지 않았기 때문에 0건.

#### 2. 가상매매 모드에서 15:00 청산 시 실제 주문 API 호출 **[원인 확정]**
- 가상거래 모드(`use_virtual_trading: true`) 설정 상태에서 15:00 일괄청산 시 **실제 KIS API** 호출.
- `main.py`의 `_execute_end_of_day_liquidation()`(L789~836)에 **가상거래 분기 없음**. 무조건 `trading_manager.execute_sell_order()` 호출.
- 장중 매도 판단(`_analyze_sell_decision`)에는 가상/실제 분기 있음 (L595~620). **EOD 청산에만 분기 누락**.

**수정 대상**: [main.py](main.py) `_execute_end_of_day_liquidation()` (L789~836). → **수정 완료** (가상 분기 추가).

#### 3. 손절/익절 매도 판단 미실행 → **로그 부재 원인**

- **원인**: `_analyze_sell_decision`에서 `analyze_sell_decision(trading_stock, **None**)` 호출. 엔진은 `data`가 None이면 즉시 `(False, "데이터 부족")` 반환.
- **결과**: 손절/익절 체크 및 `generate_sell_signal` **한 번도 실행되지 않음**. 따라서 `[ORB 전략] 🔻 손절` / `🎯 익절` 로그가 **전혀 없음**.
- **추가**: 현재가 스킵 시 로그 없이 `return` → "현재가 없음" 여부도 추적 불가.

**없었던 로그**:
- `매도 판단 스킵: {코드} 현재가 없음` (스킵 시)
- `매도 판단 스킵: {코드} 데이터 부족` (엔진 내부)
- `매도 판단 유지: {코드} 현재가 X 손절 Y 익절 Z` (체크 후 유지 시, DEBUG)
- `[ORB 전략] 🔻 손절` / `🎯 익절` (실제 도달 시)

**수정**: (1) 현재가를 `DataFrame({'close': [가격]})`로 넘겨 엔진에서 실제 판단 수행. (2) 현재가 없음/데이터 부족/유지 시 DEBUG 로그 추가. (3) 가상 매도 `current_price_info` dict 접근 오류 수정.

#### 4. 데이터 수집 실패 (장전)
```
08:56:02 | ERROR | ❌ 000660 당일 전체 분봉 데이터 조회 실패 (시간 조정 후에도 실패)
```
- 80개 후보 종목 중 대부분 초기 데이터 수집 실패
- 하지만 09:10 ORB 계산 시점에는 63개 성공
- 실시간 업데이트로 데이터 보완된 것으로 추정

### ⚠️ 개선 필요 사항

#### 1. 매도 타이밍 부족
- 23개 종목 매수 후 장중 매도 신호 없음
- 손절/익절 조건이 너무 엄격하거나 체크 주기 문제 가능성
- 15:00 강제 청산만 시도 (실패)

#### 2. 포지션 관리
- 23개 종목 동시 보유는 과다 분산
- 최대 포지션 수 제한 필요 (현재 설정: 무제한?)
- 종목당 투자 금액이 너무 작음 (3~7만원 단위)

#### 3. 수익률 추적 불가
- 15:00 청산 미실행으로 23개 포지션 미결산.
- 가상 매도 기록 없어 최종 손익 계산 불가, 전략 성과 분석 불가.

---

## 7. 원인 가설 및 검증 (Why)

| 가설 | 검증 |
|------|------|
| 15:00 청산이 가상 분기 없이 실제 API만 호출함 | `main.py` `_execute_end_of_day_liquidation` 코드 확인 → `use_virtual_trading` 체크 없이 `execute_sell_order` 호출. **확정**. |
| 가상 매수 DB 저장 실패 | `virtual_trading_records` 2026-01-28 BUY 23건 조회 → **저장 성공**. 가설 **기각**. |
| ORB 09:00~09:10 고/저가가 로직과 일치하는가 | `memory_minute_data_20260128`·캐시 1분봉으로 000660, 028260, 000880 검증 → 고/저가 **일치**. |

---

## 8. 재현 조건 (Reproduce)

1. `config/trading_config.json`에서 `use_virtual_trading: true` 설정.
2. 당일 후보 선정 → ORB 계산 → 가상 매수 체결 (1종목 이상).
3. 장중 손절/익절 미발생 상태로 15:00까지 유지.
4. 15:00 `MarketHours.is_eod_liquidation_time` 도래 시 `_execute_end_of_day_liquidation` 실행.
5. **결과**: 실제 API 매도 시도 → 실계좌 보유 수량 없음 → `APBK0400` 에러, 가상 매도 0건.

---

## 9. 데이터 품질 체크

### ORB 레인지 검증 (1분봉 기준)

캐시·`memory_minute_data_20260128_153020.txt` 기준 09:00~09:10 구간 검증:

| 종목코드 | 1분봉 high (09:00~09:10) | 1분봉 low | REPORT ORB 고가 | REPORT ORB 저가 | 일치 |
|----------|--------------------------|-----------|-----------------|-----------------|------|
| 000660   | 816,000                  | 806,000   | 816,000         | 806,000         | ✅   |
| 028260   | 302,000                  | 298,000   | 302,000         | 298,000         | ✅   |
| 000880   | 115,800                  | 114,200   | 115,800         | 114,200         | ✅   |

→ ORB 레인지 계산 로직과 1분봉 데이터 **일치**.

### ORB 레인지 계산 실패 종목 (17개)

실패 원인 추정:
- 데이터 부족 (09:00~09:10 구간 1분봉 미확보)
- API 제한 또는 일시적 오류
- 상장폐지/거래정지 종목 가능성

### 3분봉 완성 체크

```
09:00:43 | 3분봉 완성 후 매수 판단 실행: 09:00:15 - 80개 종목
09:03:42 | 3분봉 완성 후 매수 판단 실행: 09:03:14 - 80개 종목
09:06:44 | 3분봉 완성 후 매수 판단 실행: 09:06:17 - 80개 종목
...
09:15:45 | 3분봉 완성 후 매수 판단 실행: 09:15:16 - 80개 종목
```

- 3분마다 정상적으로 매수 판단 실행
- 09:15 시점에 대량 매수 신호 발생 (23개)

---

## 10. 개선 제안 (Improvement)

### 즉시 수정 필요 (Critical) → **적용 완료**

1. **15:00 청산 로직 수정** ✅
   - `main.py` `_execute_end_of_day_liquidation()`에 `use_virtual_trading` 분기 추가.
   - 가상거래 모드: `execute_virtual_sell` 호출 후 `COMPLETED` 전환. 실제 API 미호출.

2. **매도 판단 데이터 전달 및 로그 보강** ✅
   - `_analyze_sell_decision`: `get_cached_current_price` → `DataFrame({'close': [가격]})` 생성 후 `analyze_sell_decision(trading_stock, data)` 호출. 현재가 없음/무효 시 DEBUG 로그 후 스킵.
   - `trading_decision_engine.analyze_sell_decision`: 데이터 부족 시 DEBUG 로그; 손절/익절 미도달 시 `매도 판단 유지: …` DEBUG 로그.
   - `execute_virtual_sell`: `current_price_info` dict 접근 수정, 캐시 없을 때 `position.current_price`/`avg_price` fallback.

### 전략 개선 권장 (Important)

2. **포지션 관리 개선**
   - 최대 동시 보유 종목 수 제한 (예: 10개)
   - 종목당 최소 투자 금액 설정 (예: 50만원)
   - 강한 신호의 종목에 집중 투자

3. **매도 조건 완화**
   - 현재 손절/익절 조건이 너무 엄격할 가능성
   - 매도 신호 체크 로직 검증 필요
   - 장중 매도 로그 확인

### 모니터링 강화 (Nice to have)

4. **알림 개선**
   - 텔레그램 알림에 실시간 수익률 포함
   - 포지션 보유 현황 주기적 알림
   - 오류 발생 시 즉시 알림

5. **로깅 개선**
   - 매도 판단 로직 로그 추가
   - 수익률 변화 추적 로그
   - API 오류 상세 로그

---

## 11. 다음 단계

1. **15:00 가상 청산 분기** 수정 후 재실행.
2. 가상거래 모드에서 15:00 청산 시 `virtual_trading_manager` 가상 매도 호출·DB 저장 확인.
3. 수익률 계산 및 전략 성과 분석.

---

**작성일시**: 2026-01-28 19:06 (초안) / 재분석 반영  
**데이터 소스**: DB `robotrader.db` (`candidate_stocks`, `virtual_trading_records`), `memory_minute_data_20260128_153020.txt`, 캐시 `minute_data/*_20260128.pkl`, 로그 `trading_20260128.log` (별도 보관 시)
