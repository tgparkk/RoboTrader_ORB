# 패턴별 동적 손익비 최적화 가이드

## 📋 개요

이 가이드는 과거 매매 데이터를 분석하여 패턴별 최적의 손익비를 자동으로 계산하는 방법을 설명합니다.

## 🎯 사용 시나리오

### 언제 사용하나요?
- **최초 설정**: 동적 손익비 시스템을 처음 도입할 때
- **정기 재조정**: 2-3개월마다 시장 변화를 반영하여 재최적화
- **전략 검증**: 현재 손익비 설정의 유효성을 검증할 때

## 🚀 사용 방법

### 1단계: 시뮬레이션 로그 생성

먼저 분석할 기간의 시뮬레이션 로그가 필요합니다.

```bash
# 최근 3개월 데이터로 시뮬레이션 실행 (예: 2025년 9월 ~ 11월)
python batch_signal_replay.py -s 20250901 -e 20251130
```

이 명령은 `signal_replay_log/` 디렉토리에 각 날짜별 시뮬레이션 결과를 생성합니다.

### 2단계: 최적화 실행

```bash
# 기본 실행 (분석 + 설정 파일 자동 업데이트)
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20251130

# 분석만 실행 (설정 파일 업데이트 안함)
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20251130 --no-update

# 커스텀 로그 디렉토리 지정
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20251130 -d signal_replay_log_ml
```

### 3단계: 결과 확인

최적화가 완료되면 다음 파일들이 생성됩니다:

1. **리포트 파일**: `pattern_optimization_report_YYYYMMDD_HHMMSS.md`
   - 패턴별 최적 손익비
   - 기존 설정과의 비교
   - 통계 정보

2. **백업 파일**: `config/dynamic_profit_loss_config.py.backup`
   - 기존 설정의 백업본

3. **업데이트된 설정**: `config/dynamic_profit_loss_config.py`
   - 새로운 손익비가 적용된 설정 파일

## 📊 출력 예시

```
================================================================================
🚀 패턴별 동적 손익비 최적화 시작
================================================================================

  📅 분석 기간: 20250901 ~ 20251130
  📂 로그 디렉토리: signal_replay_log
  ⚙️  설정 업데이트: 예

================================================================================
📊 패턴 데이터 수집 중: 20250901 ~ 20251130
================================================================================

  📅 20250901: 15건 수집
  📅 20250902: 23건 수집
  ...

✅ 총 60일, 782건의 매매 데이터 수집 완료

================================================================================
📈 패턴별 수집 데이터:
================================================================================
  very_low        x weak_decrease        :   45건
  very_low        x normal_decrease      :   89건
  very_low        x strong_decrease      :   67건
  low             x weak_decrease        :  112건
  low             x normal_decrease      :  156건
  low             x strong_decrease      :   98건
  normal          x weak_decrease        :   78건
  normal          x normal_decrease      :   94건
  normal          x strong_decrease      :   43건

================================================================================
🔍 패턴별 최적 손익비 계산 중...
================================================================================

  ✅ very_low        x weak_decrease       ( 45건)
      기존: 손절   -4.5% / 익절   +7.0%
      최적: 손절   -4.0% / 익절   +7.5% (점수: 0.658)

  ✅ very_low        x normal_decrease     ( 89건)
      기존: 손절   -5.0% / 익절   +7.0%
      최적: 손절   -4.5% / 익절   +7.5% (점수: 0.672)

  ...

================================================================================
📝 설정 파일 업데이트 중: dynamic_profit_loss_config.py
================================================================================

  💾 백업 파일 생성: dynamic_profit_loss_config.py.backup
  ✅ 설정 파일 업데이트 완료

  📋 업데이트된 패턴 수: 9
  📋 유지된 패턴 수: 0

================================================================================
📄 최적화 리포트 생성 중...
================================================================================

  ✅ 리포트 생성 완료: pattern_optimization_report_20251223_153045.md

================================================================================
✅ 최적화 완료!
================================================================================

  ✔️  설정 파일이 업데이트되었습니다.
  ✔️  백업 파일: config/dynamic_profit_loss_config.py.backup
  💡 변경사항을 확인한 후 trading_config.json에서 use_dynamic_profit_loss를 true로 설정하세요.
```

## 🔍 최적화 알고리즘

### 손익비 테스트 범위
- **손절**: -1.5% ~ -6.0% (0.5% 간격, 총 10개 옵션)
- **익절**: +3.0% ~ +8.0% (0.5% 간격, 총 11개 옵션)
- **총 조합**: 110가지 (10 × 11)

### 점수 계산 방식

각 손익비 조합에 대해 다음과 같이 점수를 계산합니다:

```
점수 = (승률 × 0.6) + (평균수익 / 10 × 0.4)
```

- **승률**: 해당 손익비로 매매했을 때 수익이 난 비율
- **평균수익**: 해당 손익비로 매매했을 때 평균 수익률
- **가중치**: 승률 60%, 평균수익 40%

### 예시

```
패턴: (low, normal_decrease), 매매 100건

손절 -3.0%, 익절 +6.0% 테스트:
- 익절 도달: 45건 (각 +6.0%)
- 손절 도달: 30건 (각 -3.0%)
- 범위 내: 25건 (실제 수익률 사용)

승률 = 45 / 100 = 0.45
평균수익 = (45×6.0 + 30×(-3.0) + 범위내합계) / 100 = 1.85%

점수 = (0.45 × 0.6) + (1.85 / 10 × 0.4) = 0.344
```

모든 조합 중 점수가 가장 높은 손익비를 선택합니다.

## ⚙️ 고급 설정

### 최소 매매 건수 조정

기본적으로 패턴당 최소 5건의 매매 데이터가 있어야 분석합니다. 이를 변경하려면 스크립트를 수정하세요:

```python
# scripts/optimize_dynamic_ratios.py 파일의 optimize_ratios() 메서드
if len(trades) < 5:  # 여기를 10으로 변경하면 최소 10건 필요
    print(f"  ⚠️  {pattern}: 데이터 부족 ({len(trades)}건) - 스킵")
    continue
```

### 점수 계산 가중치 조정

승률과 평균수익의 비중을 조정하려면:

```python
# scripts/optimize_dynamic_ratios.py 파일의 _calculate_score() 메서드
# 승률 중시: 승률 80%, 평균수익 20%
score = (win_rate * 0.8) + (avg_profit / 10.0 * 0.2)

# 수익 중시: 승률 40%, 평균수익 60%
score = (win_rate * 0.4) + (avg_profit / 10.0 * 0.6)
```

### 테스트 범위 확장

더 넓은 범위의 손익비를 테스트하려면:

```python
# scripts/optimize_dynamic_ratios.py 파일의 optimize_ratios() 메서드
stop_loss_options = [-1.0, -1.5, -2.0, ..., -7.0, -7.5, -8.0]
take_profit_options = [2.5, 3.0, 3.5, ..., 9.0, 9.5, 10.0]
```

## 📝 실전 적용 워크플로우

### 1. 충분한 데이터 수집
```bash
# 최소 2-3개월 이상의 데이터 권장
python batch_signal_replay.py -s 20250901 -e 20251130
```

### 2. 최적화 실행 (분석만)
```bash
# 먼저 --no-update로 결과만 확인
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20251130 --no-update
```

### 3. 리포트 검토
생성된 `pattern_optimization_report_*.md` 파일을 열어서:
- 각 패턴별 매매 건수가 충분한지 확인
- 기존 설정 대비 변화가 합리적인지 검토
- 특정 패턴의 점수가 너무 낮지 않은지 확인

### 4. 설정 업데이트
```bash
# 결과가 만족스러우면 실제 업데이트
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20251130
```

### 5. 백테스트 검증
```bash
# 업데이트된 설정으로 최근 데이터 재시뮬레이션
# (trading_config.json에서 use_dynamic_profit_loss를 true로 변경 후)
python batch_signal_replay.py -s 20251201 -e 20251220
```

### 6. 실전 적용
- 백테스트 결과가 만족스러우면 실제 매매에 적용
- 처음에는 소액으로 테스트
- 1-2주 모니터링 후 본격 운영

## ⚠️ 주의사항

### 1. 과최적화 (Overfitting) 주의
- 너무 짧은 기간의 데이터로 최적화하면 과최적화 위험
- **권장**: 최소 2-3개월 이상의 데이터 사용
- 시장 상황이 급변한 구간이 포함되었는지 확인

### 2. 패턴별 데이터 불균형
- 일부 패턴은 매매 건수가 매우 적을 수 있음
- **대처**: 최소 건수 기준을 높여서 신뢰도 향상
- 건수가 적은 패턴은 기존 설정 유지

### 3. 시장 변화 대응
- 시장 환경이 바뀌면 최적 손익비도 변함
- **권장**: 2-3개월마다 재최적화
- 급격한 시장 변화 시 즉시 재검토

### 4. 백업 필수
- 스크립트가 자동으로 백업하지만, 추가 백업 권장
- Git으로 버전 관리 중이라면 커밋 후 실행

### 5. 점진적 적용
- 한 번에 모든 설정을 바꾸지 말고 단계적으로 적용
- 먼저 일부 패턴만 업데이트하고 결과 확인
- 점진적으로 범위 확대

## 🔄 정기 재최적화 루틴

### 매달 1일 (분석 전용)
```bash
# 지난 3개월 데이터로 분석만 실행
python scripts/optimize_dynamic_ratios.py -s 20251001 -e 20251231 --no-update
```

### 분기별 (실제 업데이트)
```bash
# 분기 종료 후 해당 분기 데이터로 재최적화
python scripts/optimize_dynamic_ratios.py -s 20251001 -e 20251231

# 백테스트
python batch_signal_replay.py -s 20260101 -e 20260115
```

## 📊 결과 해석 가이드

### 좋은 최적화 결과
- ✅ 각 패턴당 최소 10건 이상의 데이터
- ✅ 점수가 0.5 이상 (승률 50% 이상 수준)
- ✅ 기존 설정 대비 ±1.0%p 이내의 변화
- ✅ 손절이 익절의 1/2 ~ 2/3 수준

### 주의가 필요한 결과
- ⚠️ 특정 패턴의 데이터가 5건 미만
- ⚠️ 점수가 0.3 이하 (매우 낮은 승률/수익)
- ⚠️ 기존 설정 대비 ±2.0%p 이상의 급격한 변화
- ⚠️ 손절이 익절보다 큰 경우 (예: 손절 -7%, 익절 +4%)

### 데이터 부족 패턴 대처
```
⚠️ (very_low, strong_decrease): 데이터 부족 (3건) - 스킵
```
- 더 긴 기간의 데이터 수집
- 또는 유사한 패턴의 설정 참고
- 기본 설정 유지

## 🛠️ 문제 해결

### Q: "수집된 패턴 데이터가 없습니다"
**A**: 시뮬레이션 로그가 없거나 경로가 잘못되었습니다.
```bash
# 먼저 시뮬레이션 실행
python batch_signal_replay.py -s 20250901 -e 20250930

# 로그 디렉토리 확인
ls signal_replay_log/

# 올바른 디렉토리 지정
python scripts/optimize_dynamic_ratios.py -s 20250901 -e 20250930 -d signal_replay_log
```

### Q: "최적화된 손익비를 계산할 수 없습니다"
**A**: 모든 패턴의 데이터가 5건 미만입니다.
```bash
# 더 긴 기간으로 재시도
python scripts/optimize_dynamic_ratios.py -s 20250801 -e 20251130
```

### Q: 특정 패턴의 결과가 이상합니다
**A**: 해당 패턴의 리포트를 자세히 확인하고, 필요시 수동으로 조정
```python
# config/dynamic_profit_loss_config.py 에서 직접 수정
PATTERN_COMBINATION_RATIOS = {
    ('low', 'normal_decrease'): {'stop_loss': -3.5, 'take_profit': 6.5},  # 수동 조정
    ...
}
```

## 📚 관련 문서

- [동적 손익비 시스템 사용 가이드](QUICK_START_동적손익비.md)
- [동적 손익비 통합 완료 문서](DYNAMIC_PROFIT_LOSS_INTEGRATION_COMPLETE.md)
- [RoboTrader 분석 가이드](ROBOTRADER_ANALYSIS_GUIDE.md)

## 🎓 추가 개선 아이디어

### 1. 시장 상황별 손익비
현재는 전체 기간에 대해 단일 손익비를 계산하지만, 향후에는:
- 상승장/하락장/횡보장 구분
- 변동성 수준별 구분
- 각 상황별로 다른 손익비 적용

### 2. 머신러닝 기반 최적화
현재는 그리드 서치 방식이지만, 향후에는:
- 베이지안 최적화
- 유전 알고리즘
- 강화학습 적용

### 3. 리스크 조정 수익률 (Risk-Adjusted Return)
현재는 단순 승률+수익으로 점수를 계산하지만, 향후에는:
- 샤프 비율 (Sharpe Ratio)
- 소르티노 비율 (Sortino Ratio)
- 최대 낙폭 (MDD) 고려

---

**마지막 업데이트**: 2025-12-23
**작성자**: RoboTrader 개발팀
