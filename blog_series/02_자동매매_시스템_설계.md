# RoboTrader ì‹œë¦¬ì¦ˆ 2í¸: ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ì„¤ê³„ ğŸ’»

> "6ê°œì˜ ì‘ì—…ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì˜ ë§ˆë²•"

## ë“¤ì–´ê°€ë©°

1í¸ì—ì„œ ëˆŒë¦¼ëª© ì „ëµì˜ ì›ë¦¬ë¥¼ ë‹¤ë¤˜ë‹¤ë©´, ì´ë²ˆ í¸ì—ì„œëŠ” **ì´ ì „ëµì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ì‹œìŠ¤í…œ**ì„ ì„¤ê³„í•˜ëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.

í•µì‹¬ ì§ˆë¬¸:
- 10ì´ˆë§ˆë‹¤ 70ê°œ ì¢…ëª©ì˜ ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ìˆ˜ì§‘í• ê¹Œ?
- ë§¤ìˆ˜/ë§¤ë„ íŒë‹¨ì„ ë™ì‹œì— ì–´ë–»ê²Œ ì²˜ë¦¬í• ê¹Œ?
- ë¯¸ì²´ê²° ì£¼ë¬¸ì€ ì–´ë–»ê²Œ ê´€ë¦¬í• ê¹Œ?

ë‹µì€ **ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°**ê³¼ **Manager íŒ¨í„´**ì— ìˆìŠµë‹ˆë‹¤.

---

## 1. ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ğŸ—ï¸

### ì‹œìŠ¤í…œ êµ¬ì¡°ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        DayTradingBot (main.py)              â”‚
â”‚         ì¤‘ì•™ ì»¨íŠ¸ë¡¤ëŸ¬ / ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚        â”‚        â”‚
    v        v        v        v        v
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ë°ì´í„°â”‚  â”‚ë§¤ë§¤  â”‚  â”‚ì£¼ë¬¸  â”‚  â”‚ê±°ë˜  â”‚  â”‚í…”ë ˆâ”‚
â”‚ìˆ˜ì§‘  â”‚  â”‚íŒë‹¨  â”‚  â”‚ê´€ë¦¬  â”‚  â”‚ìƒíƒœ  â”‚  â”‚ê·¸ë¨â”‚
â”‚     â”‚  â”‚ì—”ì§„  â”‚  â”‚     â”‚  â”‚ê´€ë¦¬  â”‚  â”‚     â”‚
â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚        â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”
        â”‚ KISAPIManager â”‚
        â”‚   (API í†µí•©)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ì„¤ê³„ ì›ì¹™

1. **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° ManagerëŠ” í•˜ë‚˜ì˜ ë„ë©”ì¸ë§Œ ê´€ë¦¬
2. **ë¹„ë™ê¸° ìš°ì„ **: ë¸”ë¡œí‚¹ ì‘ì—…ì€ ThreadPoolExecutorë¡œ ë¶„ë¦¬
3. **ëŠìŠ¨í•œ ê²°í•©**: Manager ê°„ ì§ì ‘ ì°¸ì¡° ìµœì†Œí™”
4. **ìƒíƒœ ì¤‘ì‹¬**: FSM(ìœ í•œ ìƒíƒœ ê¸°ê³„)ë¡œ ê±°ë˜ ìƒíƒœ ê´€ë¦¬

---

## 2. ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì˜ í˜ âš¡

### ë™ê¸° vs ë¹„ë™ê¸°

**ë™ê¸° ë°©ì‹ (ìˆœì°¨ ì²˜ë¦¬)**:
```python
# âŒ ë¸”ë¡œí‚¹: ì´ 30ì´ˆ ì†Œìš”
ë°ì´í„° ìˆ˜ì§‘()    # 10ì´ˆ ëŒ€ê¸°
ë§¤ë§¤ íŒë‹¨()      # 10ì´ˆ ëŒ€ê¸°
ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§()   # 10ì´ˆ ëŒ€ê¸°
```

**ë¹„ë™ê¸° ë°©ì‹ (ë³‘ë ¬ ì²˜ë¦¬)**:
```python
# âœ… ë…¼ë¸”ë¡œí‚¹: ì´ 10ì´ˆ ì†Œìš”
await asyncio.gather(
    ë°ì´í„°_ìˆ˜ì§‘(),      # ë™ì‹œ ì‹¤í–‰
    ë§¤ë§¤_íŒë‹¨(),        # ë™ì‹œ ì‹¤í–‰
    ì£¼ë¬¸_ëª¨ë‹ˆí„°ë§()     # ë™ì‹œ ì‹¤í–‰
)
```

### 6ê°œ íƒœìŠ¤í¬ ë³‘ë ¬ ì‹¤í–‰

RoboTraderì˜ í•µì‹¬ êµ¬ì¡°:

```python
class DayTradingBot:
    async def run(self):
        """ë©”ì¸ ì‹¤í–‰ ë£¨í”„"""
        tasks = [
            self._data_collection_task(),       # 10ì´ˆ ì£¼ê¸°
            self._order_monitoring_task(),      # 10ì´ˆ ì£¼ê¸°
            self._trading_decision_task(),      # 5ì´ˆ ì£¼ê¸°
            self._system_monitoring_task(),     # 30ì´ˆ ì£¼ê¸°
            self._telegram_task(),              # ì‹¤ì‹œê°„
            self.trading_manager.start_monitoring()  # ìƒíƒœ ê´€ë¦¬
        ]

        # ëª¨ë“  íƒœìŠ¤í¬ë¥¼ ë™ì‹œì— ì‹¤í–‰
        await asyncio.gather(*tasks, return_exceptions=True)
```

### ê° íƒœìŠ¤í¬ì˜ ì—­í• 

#### 1ï¸âƒ£ ë°ì´í„° ìˆ˜ì§‘ (10ì´ˆ ì£¼ê¸°)

```python
async def _data_collection_task(self):
    """ì¡°ê±´ê²€ìƒ‰ + ë¶„ë´‰ ë°ì´í„° ìˆ˜ì§‘"""
    while self.is_running and is_market_open():
        try:
            # ì¡°ê±´ê²€ìƒ‰ìœ¼ë¡œ ìƒˆ ì¢…ëª© ë°œê²¬
            await self._discover_stocks_from_condition()

            # ì „ì²´ ê´€ë¦¬ ì¢…ëª© ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸
            await self._update_intraday_data()

            await asyncio.sleep(10)  # 10ì´ˆ ëŒ€ê¸°
        except Exception as e:
            self.logger.error(f"ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜: {e}")
```

#### 2ï¸âƒ£ ë§¤ë§¤ íŒë‹¨ (5ì´ˆ ì£¼ê¸°)

```python
async def _trading_decision_task(self):
    """SELECTED ì¢…ëª© ë§¤ìˆ˜ íŒë‹¨, POSITIONED ì¢…ëª© ë§¤ë„ íŒë‹¨"""
    while self.is_running and is_market_open():
        try:
            # SELECTED ì¢…ëª©: ë§¤ìˆ˜ ì‹ í˜¸ í™•ì¸
            selected_stocks = self.trading_manager.get_by_status(
                TradingStatus.SELECTED
            )

            for stock in selected_stocks:
                # ë§¤ìˆ˜ íŒë‹¨ ë° ì£¼ë¬¸ ì‹¤í–‰
                await self._execute_buy_if_signal(stock)

            # POSITIONED ì¢…ëª©: ë§¤ë„ ì‹ í˜¸ í™•ì¸
            positioned_stocks = self.trading_manager.get_by_status(
                TradingStatus.POSITIONED
            )

            for stock in positioned_stocks:
                # ë§¤ë„ íŒë‹¨ ë° ì£¼ë¬¸ ì‹¤í–‰
                await self._execute_sell_if_signal(stock)

            await asyncio.sleep(5)  # 5ì´ˆ ëŒ€ê¸°
        except Exception as e:
            self.logger.error(f"ë§¤ë§¤ íŒë‹¨ ì˜¤ë¥˜: {e}")
```

#### 3ï¸âƒ£ ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§ (10ì´ˆ ì£¼ê¸°)

```python
async def _order_monitoring_task(self):
    """ë¯¸ì²´ê²° ì£¼ë¬¸ ì²´ê²° í™•ì¸ ë° íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬"""
    while self.is_running:
        try:
            # ë¯¸ì²´ê²° ì£¼ë¬¸ ì²´ê²° ìƒíƒœ í™•ì¸
            await self.order_manager.check_pending_orders()

            # íƒ€ì„ì•„ì›ƒ ì£¼ë¬¸ ì·¨ì†Œ
            await self.order_manager.cancel_timeout_orders()

            await asyncio.sleep(10)
        except Exception as e:
            self.logger.error(f"ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")
```

#### 4ï¸âƒ£ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ì£¼ê¸°)

```python
async def _system_monitoring_task(self):
    """ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ ë° ê¸´ê¸‰ ë™ê¸°í™”"""
    while self.is_running:
        try:
            # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì²´í¬
            # API í˜¸ì¶œ í†µê³„ ë¡œê¹…
            # ì—ëŸ¬ìœ¨ ëª¨ë‹ˆí„°ë§

            # ê³„ì¢Œ ì”ê³  â†” ì‹œìŠ¤í…œ ìƒíƒœ ë™ê¸°í™”
            await self.emergency_sync_positions()

            await asyncio.sleep(30)
        except Exception as e:
            self.logger.error(f"ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")
```

#### 5ï¸âƒ£ í…”ë ˆê·¸ë¨ (ì‹¤ì‹œê°„)

```python
async def _telegram_task(self):
    """ì‹¤ì‹œê°„ ì•Œë¦¼ ë° ì›ê²© ëª…ë ¹ ì²˜ë¦¬"""
    while self.is_running:
        try:
            # ë§¤ìˆ˜/ë§¤ë„ ì•Œë¦¼
            # ì—ëŸ¬ ì•Œë¦¼
            # /status, /balance ë“± ëª…ë ¹ì–´ ì²˜ë¦¬

            await asyncio.sleep(1)
        except Exception as e:
            self.logger.error(f"í…”ë ˆê·¸ë¨ ì˜¤ë¥˜: {e}")
```

---

## 3. Manager íŒ¨í„´ìœ¼ë¡œ ë„ë©”ì¸ ë¶„ë¦¬ ğŸ¯

### Manager ê³„ì¸µ êµ¬ì¡°

```
DayTradingBot
    â”œâ”€ KISAPIManager        # API í†µí•©
    â”œâ”€ OrderManager         # ì£¼ë¬¸ ì‹¤í–‰/ì·¨ì†Œ
    â”œâ”€ TradingStockManager  # ì¢…ëª© ìƒíƒœ ê´€ë¦¬
    â”œâ”€ IntradayStockManager # ë¶„ë´‰ ë°ì´í„° ê´€ë¦¬
    â”œâ”€ FundManager          # ìê¸ˆ ê´€ë¦¬
    â””â”€ TradingDecisionEngine # ë§¤ë§¤ íŒë‹¨
```

### 1ï¸âƒ£ KISAPIManager: API í†µí•© í—ˆë¸Œ

```python
class KISAPIManager:
    """í•œêµ­íˆ¬ìì¦ê¶Œ API í†µí•© ê´€ë¦¬"""

    def __init__(self):
        self.is_authenticated = False
        self.last_auth_time = None
        self.call_count = 0

    def initialize(self) -> bool:
        """API ì´ˆê¸°í™” ë° ì¸ì¦"""
        if kis_auth.auth():
            self.is_authenticated = True
            self.last_auth_time = now_kst()
            return True
        return False

    def _ensure_authenticated(self) -> bool:
        """ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ì¬ì¸ì¦ (1ì‹œê°„ë§ˆë‹¤)"""
        if not self.is_authenticated:
            return self._initialize_auth()

        # í† í° ë§Œë£Œ ì²´í¬
        elapsed = (now_kst() - self.last_auth_time).total_seconds()
        if elapsed > 3600:  # 1ì‹œê°„ ê²½ê³¼
            return self._initialize_auth()

        return True

    def get_account_balance(self) -> Optional[AccountInfo]:
        """ê³„ì¢Œ ì”ê³  ì¡°íšŒ"""
        self._ensure_authenticated()
        # API í˜¸ì¶œ...
```

**ì¥ì **:
- ì¸ì¦ ê´€ë¦¬ ìë™í™”
- API í˜¸ì¶œ ì¬ì‹œë„ ë¡œì§ í†µí•©
- í˜¸ì¶œ í†µê³„ ì¤‘ì•™ ì§‘ì¤‘

### 2ï¸âƒ£ TradingStockManager: ìƒíƒœ ê´€ë¦¬ì˜ í•µì‹¬

```python
class TradingStockManager:
    """ê±°ë˜ ì¢…ëª© ìƒíƒœ ê´€ë¦¬"""

    def __init__(self, db_manager):
        self.db_manager = db_manager
        self.trading_stocks: Dict[str, TradingStock] = {}
        self._lock = threading.RLock()

    def add_stock(self, stock_code: str, stock_name: str):
        """ì¢…ëª© ì¶”ê°€ (SELECTED ìƒíƒœ)"""
        with self._lock:
            if stock_code in self.trading_stocks:
                return False

            stock = TradingStock(
                stock_code=stock_code,
                stock_name=stock_name,
                status=TradingStatus.SELECTED,
                added_time=now_kst()
            )

            self.trading_stocks[stock_code] = stock
            return True

    def update_status(self, stock_code: str, new_status: TradingStatus):
        """ìƒíƒœ ì „ì´"""
        with self._lock:
            if stock_code not in self.trading_stocks:
                return False

            stock = self.trading_stocks[stock_code]
            old_status = stock.status
            stock.status = new_status

            self.logger.info(
                f"ğŸ“Š {stock_code} ìƒíƒœ ë³€ê²½: {old_status} â†’ {new_status}"
            )
            return True
```

**ìƒíƒœ ì „ì´ ë‹¤ì´ì–´ê·¸ë¨**:
```
SELECTED (í›„ë³´)
    â”‚ ë§¤ìˆ˜ ì£¼ë¬¸
    v
BUY_PENDING (ë§¤ìˆ˜ ëŒ€ê¸°)
    â”‚ ì²´ê²° ì™„ë£Œ
    v
POSITIONED (ë³´ìœ  ì¤‘)
    â”‚ ë§¤ë„ ì£¼ë¬¸
    v
SELL_PENDING (ë§¤ë„ ëŒ€ê¸°)
    â”‚ ì²´ê²° ì™„ë£Œ
    v
COMPLETED (ì™„ë£Œ)
```

### 3ï¸âƒ£ OrderManager: ì£¼ë¬¸ ì‹¤í–‰ ë° íƒ€ì„ì•„ì›ƒ ê´€ë¦¬

```python
class OrderManager:
    """ì£¼ë¬¸ ê´€ë¦¬ ë° ë¯¸ì²´ê²° ì²˜ë¦¬"""

    def __init__(self, config, api_manager):
        self.api_manager = api_manager
        self.pending_orders: Dict[str, Order] = {}
        self.order_timeouts: Dict[str, datetime] = {}

    async def place_buy_order(
        self,
        stock_code: str,
        quantity: int,
        price: float,
        timeout_seconds: int = 300
    ) -> Optional[str]:
        """ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰"""
        # API í˜¸ì¶œì„ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ (ë¸”ë¡œí‚¹ ë°©ì§€)
        loop = asyncio.get_event_loop()
        result = await loop.run_in_executor(
            self.executor,
            self.api_manager.place_buy_order,
            stock_code, quantity, int(price)
        )

        if result.success:
            # ë¯¸ì²´ê²° ê´€ë¦¬ì— ì¶”ê°€
            order = Order(
                order_id=result.order_id,
                stock_code=stock_code,
                quantity=quantity,
                price=price,
                timestamp=now_kst()
            )

            self.pending_orders[result.order_id] = order
            self.order_timeouts[result.order_id] = (
                now_kst() + timedelta(seconds=timeout_seconds)
            )

            return result.order_id

        return None

    async def check_pending_orders(self):
        """ë¯¸ì²´ê²° ì£¼ë¬¸ ì²´ê²° í™•ì¸"""
        for order_id, order in list(self.pending_orders.items()):
            # ì²´ê²° ìƒíƒœ ì¡°íšŒ
            status = await self._check_order_status(order_id)

            if status == "FILLED":
                # ì²´ê²° ì™„ë£Œ â†’ ì œê±°
                del self.pending_orders[order_id]
                del self.order_timeouts[order_id]

    async def cancel_timeout_orders(self):
        """íƒ€ì„ì•„ì›ƒ ì£¼ë¬¸ ìë™ ì·¨ì†Œ"""
        current_time = now_kst()

        for order_id, timeout_time in list(self.order_timeouts.items()):
            if current_time >= timeout_time:
                # íƒ€ì„ì•„ì›ƒ â†’ ì·¨ì†Œ
                await self.cancel_order(order_id)
```

**íƒ€ì„ì•„ì›ƒ ì „ëµ**:
- ì¼ë°˜ íƒ€ì„ì•„ì›ƒ: ë§¤ìˆ˜ 300ì´ˆ, ë§¤ë„ 180ì´ˆ
- 3ë¶„ë´‰ ê¸°ì¤€ íƒ€ì„ì•„ì›ƒ: 4ê°œ ë´‰(12ë¶„) ê²½ê³¼ ì‹œ ê°•ì œ ì·¨ì†Œ

---

## 4. ThreadPoolExecutor í™œìš© ğŸ”€

### ì™œ ThreadPoolì´ í•„ìš”í•œê°€?

Pythonì˜ `asyncio`ëŠ” I/O ì‘ì—…ì—ëŠ” ê°•í•˜ì§€ë§Œ, **ë™ê¸° ë¸”ë¡œí‚¹ API**ë¥¼ í˜¸ì¶œí•˜ë©´ ì „ì²´ ì´ë²¤íŠ¸ ë£¨í”„ê°€ ë©ˆì¶¥ë‹ˆë‹¤.

```python
# âŒ ë‚˜ìœ ì˜ˆ: ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹
result = api_manager.place_buy_order(...)  # 3ì´ˆ ëŒ€ê¸°
# â†’ ë‹¤ë¥¸ ëª¨ë“  íƒœìŠ¤í¬ê°€ 3ì´ˆê°„ ì •ì§€!

# âœ… ì¢‹ì€ ì˜ˆ: ë³„ë„ ìŠ¤ë ˆë“œ ì‹¤í–‰
loop = asyncio.get_event_loop()
result = await loop.run_in_executor(
    executor,
    api_manager.place_buy_order,
    stock_code, quantity, price
)
# â†’ ë‹¤ë¥¸ íƒœìŠ¤í¬ëŠ” ê³„ì† ì‹¤í–‰
```

### ì‹¤ì „ ì ìš©

```python
class OrderManager:
    def __init__(self):
        # ìµœëŒ€ 2ê°œ ì›Œì»¤ ìŠ¤ë ˆë“œ
        self.executor = ThreadPoolExecutor(max_workers=2)

    async def place_buy_order(self, ...):
        """ë§¤ìˆ˜ ì£¼ë¬¸ (ë¹„ë™ê¸°)"""
        result = await loop.run_in_executor(
            self.executor,
            self._sync_place_buy_order,  # ë™ê¸° í•¨ìˆ˜
            stock_code, quantity, price
        )
        return result

    def _sync_place_buy_order(self, stock_code, quantity, price):
        """ì‹¤ì œ API í˜¸ì¶œ (ë™ê¸° í•¨ìˆ˜)"""
        return self.api_manager.place_buy_order(stock_code, quantity, price)
```

---

## 5. ê¸´ê¸‰ í¬ì§€ì…˜ ë™ê¸°í™” ğŸ”„

### ë¬¸ì œ ìƒí™©

ì‹œìŠ¤í…œ ìƒíƒœì™€ ì‹¤ì œ ê³„ì¢Œ ìƒíƒœê°€ ë¶ˆì¼ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- ì‹œìŠ¤í…œ ì¬ì‹œì‘
- API ì˜¤ë¥˜ë¡œ ì²´ê²° ì •ë³´ ëˆ„ë½
- ìˆ˜ë™ ë§¤ë§¤ ê°œì…

### í•´ê²°ì±…: ê¸´ê¸‰ ë™ê¸°í™”

```python
async def emergency_sync_positions(self):
    """ê³„ì¢Œ ì”ê³  â†” ì‹œìŠ¤í…œ ìƒíƒœ ë™ê¸°í™”"""
    try:
        # 1. ì‹¤ì œ ê³„ì¢Œ ì”ê³  ì¡°íšŒ
        account_info = self.api_manager.get_account_balance()
        real_positions = {p['stock_code']: p for p in account_info.positions}

        # 2. ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ
        system_positions = self.trading_manager.get_by_status(
            TradingStatus.POSITIONED
        )

        # 3. ì°¨ì´ ë°œê²¬ ë° ë™ê¸°í™”
        for stock_code, real_pos in real_positions.items():
            if stock_code not in system_positions:
                # ì‹œìŠ¤í…œì— ì—†ëŠ” ë³´ìœ  ì¢…ëª© â†’ ì¶”ê°€
                self.logger.warning(
                    f"ğŸ”„ ê³„ì¢Œ ë™ê¸°í™”: {stock_code} ì‹œìŠ¤í…œì— ì¶”ê°€"
                )
                self.trading_manager.add_position_from_account(real_pos)

        # 4. ì‹œìŠ¤í…œì—ë§Œ ìˆëŠ” ì¢…ëª© â†’ ìƒíƒœ ê°±ì‹ 
        for stock in system_positions.values():
            if stock.stock_code not in real_positions:
                self.logger.warning(
                    f"ğŸ”„ ê³„ì¢Œ ë™ê¸°í™”: {stock.stock_code} ì´ë¯¸ ì²­ì‚°ë¨"
                )
                self.trading_manager.update_status(
                    stock.stock_code,
                    TradingStatus.COMPLETED
                )

    except Exception as e:
        self.logger.error(f"âŒ ê¸´ê¸‰ ë™ê¸°í™” ì‹¤íŒ¨: {e}")
```

---

## 6. 15ì‹œ ì •ê° ì‹œì¥ê°€ ì¼ê´„ ì²­ì‚° â°

### êµ¬í˜„

```python
async def _market_close_liquidation(self):
    """15ì‹œ ì •ê° ì‹œì¥ê°€ ì¼ê´„ ì²­ì‚°"""
    current_time = now_kst()

    if current_time.hour == 15 and current_time.minute == 0:
        positioned_stocks = self.trading_manager.get_by_status(
            TradingStatus.POSITIONED
        )

        if not positioned_stocks:
            return

        self.logger.info(
            f"ğŸ”” 15ì‹œ ì •ê° ì‹œì¥ê°€ ì¼ê´„ ì²­ì‚° ì‹œì‘: {len(positioned_stocks)}ê°œ ì¢…ëª©"
        )

        for stock in positioned_stocks.values():
            try:
                # ì‹œì¥ê°€ ë§¤ë„ ì£¼ë¬¸
                order_id = await self.order_manager.place_sell_order(
                    stock_code=stock.stock_code,
                    quantity=stock.quantity,
                    price=stock.current_price,
                    market=True  # ì‹œì¥ê°€
                )

                if order_id:
                    self.trading_manager.update_status(
                        stock.stock_code,
                        TradingStatus.SELL_PENDING
                    )
                    self.logger.info(
                        f"âœ… {stock.stock_code} ì‹œì¥ê°€ ë§¤ë„ ì£¼ë¬¸ ì™„ë£Œ"
                    )

            except Exception as e:
                self.logger.error(
                    f"âŒ {stock.stock_code} ì‹œì¥ê°€ ë§¤ë„ ì‹¤íŒ¨: {e}"
                )
```

---

## 7. í•µì‹¬ ì •ë¦¬ ğŸ¯

### ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì˜ ì¥ì 

âœ… **ë™ì‹œ ì²˜ë¦¬**: 6ê°œ íƒœìŠ¤í¬ ë³‘ë ¬ ì‹¤í–‰
âœ… **ì‘ë‹µì„±**: ë¸”ë¡œí‚¹ ì—†ì´ ì¦‰ì‹œ ë°˜ì‘
âœ… **í™•ì¥ì„±**: ì¢…ëª© ìˆ˜ ì¦ê°€í•´ë„ ì„±ëŠ¥ ìœ ì§€
âœ… **ì•ˆì •ì„±**: ì˜ˆì™¸ ì²˜ë¦¬ ê²©ë¦¬

### Manager íŒ¨í„´ì˜ ì¥ì 

âœ… **ë‹¨ì¼ ì±…ì„**: ê° ManagerëŠ” í•˜ë‚˜ì˜ ë„ë©”ì¸ë§Œ
âœ… **ì¬ì‚¬ìš©ì„±**: ë…ë¦½ì ì¸ ì»´í¬ë„ŒíŠ¸
âœ… **í…ŒìŠ¤íŠ¸ ìš©ì´**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°„í¸
âœ… **ìœ ì§€ë³´ìˆ˜**: ìˆ˜ì • ë²”ìœ„ ìµœì†Œí™”

### ì„¤ê³„ íŒ

ğŸ’¡ **Lock ì‚¬ìš©**: ê³µìœ  ìì›ì€ threading.RLock()ìœ¼ë¡œ ë³´í˜¸
ğŸ’¡ **ì˜ˆì™¸ ê²©ë¦¬**: gather(..., return_exceptions=True)
ğŸ’¡ **ë¡œê¹… ì¶©ì‹¤**: ìƒíƒœ ì „ì´ë§ˆë‹¤ ë¡œê·¸ ë‚¨ê¸°ê¸°
ğŸ’¡ **ì£¼ê¸° ì¡°ì •**: íƒœìŠ¤í¬ ì£¼ê¸°ëŠ” API ì œí•œ ê³ ë ¤

---

## ë‹¤ìŒ í¸ ì˜ˆê³  ğŸš€

**ì‹œë¦¬ì¦ˆ 3í¸: ë°ì´í„° ìˆ˜ì§‘ ì „ëµ**
- API 30ê±´ ì œí•œ ìš°íšŒ ê¸°ë²•
- 09:00ë¶€í„° ì „ì²´ ë¶„ë´‰ ìˆ˜ì§‘
- 1ë¶„ë´‰ ì—°ì†ì„± ê²€ì¦
- 3ë¶„ë´‰ ë³€í™˜ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

---

**ğŸ’¬ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”!**

---

*Written by [Your Name] | Last updated: 2025-10-09*
