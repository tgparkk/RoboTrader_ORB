# RoboTrader 시리즈 1편: 눌림목 전략의 비밀 📊

> "적은 돈으로 올랐다면, 적은 돈으로 내려온다"

## 들어가며

주식 자동매매 시스템을 만들면서 가장 고민한 부분은 **"어떤 신호로 매수할 것인가?"**였습니다. 수많은 기술적 지표(RSI, MACD, 볼린저밴드 등)를 테스트했지만, 가장 안정적이고 논리적인 전략은 **눌림목 캔들패턴**이었습니다.

이 글에서는 RoboTrader가 사용하는 눌림목 전략의 핵심 원리와 구현 방법을 공유합니다.

---

## 1. 눌림목 전략이란? 🎯

### 핵심 개념

**눌림목(Pullback)**은 상승 추세 중 일시적으로 조정을 받은 후 다시 상승하는 패턴입니다.

일반적인 상식과 다른 점:
```
일반적 기대: 주가 상승 → 거래량 증가 ✅
눌림목 신호: 주가 상승 → 거래량 감소 ✅✅
```

### 왜 거래량이 줄어드는 게 좋을까?

**거래량 감소 = 매물 부담 없음**

- 적은 돈으로 주가가 올랐다는 것은 대량 매도 물량이 없다는 의미
- 하락할 때도 적은 돈으로 하락 → 빠른 반등 가능
- 눌림목 구간에서 매물이 소진되면 상승 재개

---

## 2. 4단계 패턴 분석 🔍

RoboTrader는 눌림목을 **4단계**로 분석합니다.

### 1️⃣ 단계: 선행 상승 구간

**조건**:
- 최소 3% 이상 상승
- 거래량 증가 동반
- 이전 200봉 기간 분석

**코드 예시**:
```python
# 선행 상승 구간 확인
price_increase = (high_price - low_price) / low_price * 100
volume_increase = recent_volume > baseline_volume

if price_increase >= 3.0 and volume_increase:
    stage_1_pass = True  # 선행 상승 확인
```

### 2️⃣ 단계: 저거래량 하락 조정

**조건**:
- 기준 거래량의 **25% 이하**로 거래
- 최소 1.5% 하락
- 봉의 크기 축소

**핵심 포인트**:
```python
# 기준 거래량 계산 (당일 최고 거래량)
baseline_volume = max(recent_volumes)

# 저거래량 기준
low_volume_threshold = baseline_volume * 0.25

# 조정 구간 검증
if current_volume < low_volume_threshold and price_drop >= 1.5:
    stage_2_pass = True  # 매물 소진 확인
```

💡 **왜 25%일까?**: 통상적으로 기준 거래량의 **1/4 수준**이면 매물 부담이 덜합니다. (1/2 수준이면 악성 매물로 전환 위험)

### 3️⃣ 단계: 지지 구간

**조건**:
- 가격 변동성 2.5% 이내 (횡보)
- 거래량 25% 이하 유지
- 이등분선 근처에서 지지

**이등분선(Bisector Line)**:
```python
# 최고가와 최저가의 중간값
bisector_line = (recent_high + recent_low) / 2

# 지지 구간: 이등분선 ±1% 내외
support_zone = abs(current_price - bisector_line) / bisector_line <= 0.01
```

### 4️⃣ 단계: 돌파 양봉

**조건**:
- **양봉 출현** (close > open)
- 거래량 회복 (이전 봉 대비 증가)
- 봉 크기 증가 (최소 1% 실체)

**매수 신호 생성**:
```python
# 돌파 양봉 확인
is_bullish = close > open
volume_recovery = current_volume > prev_volume
body_size = (close - open) / open * 100

if is_bullish and volume_recovery and body_size >= 1.0:
    # 🎯 매수 신호 발생!
    signal = SignalType.STRONG_BUY
```

---

## 3. 이등분선의 역할 📏

### 이등분선이란?

최근 N개 봉의 **최고가와 최저가의 평균**입니다.

```python
def calculate_bisector_line(data, period=20):
    """
    이등분선 계산

    Args:
        data: OHLCV 데이터
        period: 계산 기간 (기본 20봉)

    Returns:
        이등분선 값
    """
    recent_data = data.tail(period)
    highest_high = recent_data['high'].max()
    lowest_low = recent_data['low'].min()

    bisector = (highest_high + lowest_low) / 2
    return bisector
```

### 매수/매도 판단

**매수 조건**:
- 현재가 > 이등분선 (상단 유지)
- 지지 구간에서 횡보 중

**손절 조건**:
- 현재가 < 이등분선 - 0.2% (이탈)

```python
# 이등분선 기준 매수/매도 판단
bisector = calculate_bisector_line(data)
current_price = data['close'].iloc[-1]

# 매수 가능 구간
if current_price > bisector * 1.002:  # +0.2% 이상
    can_buy = True

# 손절 구간
if current_price < bisector * 0.998:  # -0.2% 이하
    should_sell = True
```

---

## 4. 신호 강도 분류 ⭐

모든 눌림목 신호가 같은 것은 아닙니다. RoboTrader는 **신뢰도**에 따라 신호를 분류합니다.

### 신호 타입

| 신호 | 신뢰도 | 목표 수익률 | 손절 비율 |
|------|--------|-----------|----------|
| STRONG_BUY | 80% 이상 | 3.0% | -1.5% |
| CAUTIOUS_BUY | 65~80% | 2.0% | -1.0% |
| AVOID | 40% 미만 | - | 즉시 차단 |

### 신뢰도 계산 요소

```python
def calculate_signal_confidence(pattern_data):
    """신호 신뢰도 계산"""
    confidence = 50.0  # 기본 50%

    # 1. 거래량 급감 정도 (+10~20%)
    volume_drop_ratio = baseline_volume / current_volume
    if volume_drop_ratio >= 4:  # 기준의 1/4 이하
        confidence += 20

    # 2. 지지 구간 안정성 (+5~15%)
    if support_candles >= 3:  # 3개 이상 지지
        confidence += 15

    # 3. 돌파 양봉 강도 (+10~20%)
    if breakout_volume > avg_volume * 1.5:
        confidence += 20

    # 4. 이등분선 위치 (+5~10%)
    if price_above_bisector > 0.5:  # 0.5% 이상
        confidence += 10

    return confidence
```

### 시간대별 임계값 조정

```python
# 장 초반(09:00~10:00): 높은 임계값 (신중)
morning_threshold = 75.0

# 장 중반(10:00~14:00): 기본 임계값
midday_threshold = 65.0

# 장 후반(14:00~15:00): 매수 금지
# (리스크 회피)
```

---

## 5. 실전 사례 분석 📈

### 사례 1: STRONG_BUY 신호

```
종목: A전자 (예시)
시간: 10:15

[4단계 체크]
✅ 선행 상승: 09:00~09:45, +4.2% 상승
✅ 저거래량 조정: 09:45~10:00, 거래량 18% (기준 대비)
✅ 지지 구간: 10:00~10:12, 이등분선 +0.3% 횡보
✅ 돌파 양봉: 10:15, 거래량 +80%, 봉 크기 1.8%

[신호 정보]
- 신뢰도: 85%
- 신호: STRONG_BUY
- 매수가: 50,000원
- 목표가: 51,500원 (+3.0%)
- 손절가: 49,250원 (-1.5%)

[결과]
10:42 목표 달성, +3.1% 수익
```

### 사례 2: AVOID 신호 (차단)

```
종목: B전자 (예시)
시간: 11:30

[문제점]
❌ 선행 상승: +2.1% (기준 3% 미달)
✅ 저거래량 조정: 거래량 22%
⚠️ 지지 구간: 변동성 4.5% (기준 2.5% 초과)
❌ 돌파 양봉: 거래량 감소 중

[신호 정보]
- 신뢰도: 38%
- 신호: AVOID
- 매수 차단
```

---

## 6. 거래량 분석의 핵심 📊

### 기준 거래량 설정

```python
def get_baseline_volume(minute_data):
    """
    당일 3분봉 기준 거래량 계산

    가장 많이 나온 거래량을 기준으로 설정
    """
    volumes = minute_data['volume'].tolist()

    # 상위 10% 평균을 기준 거래량으로
    top_10_percent = int(len(volumes) * 0.1)
    sorted_volumes = sorted(volumes, reverse=True)
    baseline = sum(sorted_volumes[:top_10_percent]) / top_10_percent

    return baseline
```

### 거래량 비율 판단

```python
def analyze_volume_pattern(current_volume, baseline_volume):
    """거래량 패턴 분석"""
    ratio = current_volume / baseline_volume

    if ratio >= 0.5:
        return "매도세 강함 (악성 매물)"  # ❌
    elif ratio >= 0.25:
        return "보통 거래"  # ⚠️
    else:
        return "매물 소진 (긍정)"  # ✅
```

---

## 7. 구현 팁 💡

### 1. 데이터 정규화

```python
# 3분봉 시간 정규화 (09:00, 09:03, 09:06...)
def normalize_candle_time(timestamp):
    minute_normalized = (timestamp.minute // 3) * 3
    return timestamp.replace(
        minute=minute_normalized,
        second=0,
        microsecond=0
    )
```

### 2. 중복 신호 차단

```python
# 동일 캔들에서 중복 신호 방지
if last_signal_time == current_candle_time:
    return False, "동일 캔들 중복 신호"
```

### 3. 과적합 방지

```python
# 신뢰도 95% 이상은 과적합 의심
if confidence >= 95.0:
    confidence = 70.0  # 하향 조정
    reason = "과적합 방지"
```

---

## 8. 핵심 정리 🎯

### 눌림목 전략의 장점

✅ **논리적 근거**: 거래량 감소 = 매물 소진
✅ **명확한 진입점**: 4단계 패턴 완성 시
✅ **손절 기준 명확**: 이등분선, 지지선
✅ **재현 가능**: 알고리즘화 용이

### 주의사항

⚠️ **시간대 제약**: 12시 이후 신규 매수 금지
⚠️ **종목 선별**: 조건검색으로 1차 필터링 필수
⚠️ **손절 준수**: 이등분선 이탈 시 즉시 청산
⚠️ **과적합 경계**: 너무 완벽한 신호는 의심

---

## 다음 편 예고 🚀

**시리즈 2편: 자동매매 시스템 설계**
- 비동기 처리로 6개 태스크 동시 실행
- Manager 패턴으로 도메인 분리
- 상태 관리 FSM 구현
- 긴급 포지션 동기화

---

## 참고 자료 📚

- GitHub: [RoboTrader 레포지토리](https://github.com/...)
- 코드: `core/indicators/pullback_candle_pattern.py`
- 문서: `docs/trading_logic_documentation.md`

---

**💬 질문이나 피드백은 댓글로 남겨주세요!**

이 시리즈가 도움이 되셨다면 ⭐️ 스타와 공유 부탁드립니다.

---

*Written by [Your Name] | Last updated: 2025-10-09*
